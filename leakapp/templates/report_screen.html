{% extends "base.html" %}
{% load static %}

{% block styles %}
<style>
    /* Global Styles */
    body {
        font-family: Arial, sans-serif;
    }

    /* Report form should be within content area */
    .report-form {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
        margin: 20px 0;
        padding: 30px;
        border: 1px solid #ccc;
        background-color: #f5f5f5;
        border-radius: 10px;
        width: 100%;
    }

    /* Form Fields */
    .form-group {
        flex: 1;
        margin: 0 10px;
        min-width: 150px;
    }

    .form-group label {
        font-weight: bold;
        margin-bottom: 5px;
        display: block;
    }

    .form-group select,
    .form-group input[type="date"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    /* Specific Field Adjustments */
    #status-group {
        flex: 0.5;
        max-width: 100px;
    }

    #model-group {
        flex: 2;
        max-width: 400px;
    }

    /* Button Group */
    .button-group {
        display: flex;
        justify-content: flex-start;
        gap: 10px;
        margin-top: 20px;
        width: 100%;
    }

    /* Button Styles */
    .btn,
    .report-button,
    .excel-button,
    .pdf-button {
        background-color: #062A63;
        color: white;
        border: none;
        padding: 12px 20px;
        font-size: 16px;
        cursor: pointer;
        border-radius: 4px;
        transition: background-color 0.3s ease;
    }

    .btn:hover,
    .report-button:hover,
    .excel-button:hover,
    .pdf-button:hover {
        background-color: #045191;
    }

    /* Report Container */
    .report-container {
        display: flex;
        justify-content: center;
        gap: 20px;
        padding: 20px 0;
        max-width: 100%;
        margin: 0 auto;
        background-color: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    /* Table Styles */
    .data-table {
        width: 100%;
        margin: 20px auto;
        border-collapse: collapse;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
    }

    .data-table thead th {
        background-color: #062A63;
        color: white;
        padding: 12px;
        text-align: center;
        position: sticky;
        top: 0;
        z-index: 2;
    }

    .data-table tbody td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: center;
        font-size: 14px;
        color: #333;
    }

    /* Alternate Row Coloring */
    .data-table tbody tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    .data-table tbody tr:nth-child(odd) {
        background-color: #ffffff;
    }

    .data-table tbody tr:hover {
        background-color: #e0f7fa;
    }

    /* Scrollable Table Container */
    #resultsContainer {
        max-height: 400px;
        overflow: auto;
        border: 1px solid #ccc;
        background-color: #fff;
        border-radius: 10px;
        padding: 10px;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
        width: 100%;
        margin-top: 20px;
    }

    /* Pie Chart Section */
    .pie-chart-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 10px;
    }

    .pie-chart-container img {
        width: 300px;
        margin-bottom: 10px;
    }

    /* Totals Info */
    .totals-info {
        font-size: 14px;
        font-weight: 600;
        color: #333;
        text-align: center;
        margin-top: 10px;
    }

    /* Legend */
    .legend {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 500;
    }

    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
    }

    .ok-color {
        background-color: #88EA16;
    }

    .nok-color {
        background-color: #FF0000;
    }

    .footer {
        background-color: #062A63;
        color: #ecf0f1;
        text-align: center;
        padding: 10px 0;
        width: 100%;
        z-index: 1000;
    }

    .footer:hover {
        background-color: #08447A;
        transition: background-color 0.3s;
    }

    .footer p {
        margin: 0;
        font-size: 14px;
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1002; /* Higher than the topbar */
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.4);
        padding-top: 60px;
    }

    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        max-width: 400px;
        text-align: center;
    }

    .modal-content img {
        width: 350px;
        height: 65px;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
    }

    /* Responsive Design */
    @media screen and (max-width: 768px) {
        .form-group {
            flex: 100%;
            margin: 10px 0;
        }

        .data-table {
            font-size: 12px;
        }

        .data-table tbody td {
            padding: 8px;
        }

        .data-table thead th {
            padding: 10px;
        }
    }

    /* General button styling */
    .button-group button {
        background-color: #062A63;
        color: white;
        border: 1px solid #212529;
        padding: 10px 20px;
        font-size: 14px;
        cursor: pointer;
        border-radius: 5px;
        transition: background-color 0.3s ease;
    }

    /* Hover effect */
    .button-group button:hover {
        background-color: #1d2124;
    }

    /* Specific styling for each button */
    .report-button, .excel-button, .pdf-button {
        background-color: #212529;
    }

    .report-table {
        width: 100%;
        font-size: 13px;
        border-collapse: collapse;
    }
    
    .report-table th, .report-table td {
        padding: 4px 8px;
        text-align: center;
    }
    
    .report-table th {
        background-color: #f2f2f2;
    }
    
    .report-table img {
        height: 40px;
        width: auto;
    }

    .left-section {
        text-align: center;
        margin-bottom: 20px;
    }

    .large-pie-chart {
        max-width: 300px;
        height: auto;
    }
</style>
{% endblock %}

{% block content %}
<!-- Modal for viewing images -->
<div id="imageModal" class="modal">
    <span class="close" onclick="closeModal()">&times;</span>
    <img class="modal-content" id="modalImage" alt="Image">
    <div id="caption"></div>
</div>

<form class="report-form" id="filterForm" method="GET">
    <div class="form-group">
        <label for="date">Date</label>
        <input type="date" id="date" name="date" class="form-control" 
               onfocus="this.form.month.disabled=true; this.form.year.disabled=true;"
               onblur="if(!this.value) { this.form.month.disabled=false; this.form.year.disabled=false; }">
    </div>
    
    <div class="form-group">
        <label for="month"><b>Month</b></label>
        <select id="month" name="month" class="form-control" 
                onfocus="this.form.date.disabled=true;" 
                onblur="if(!this.value && !this.form.year.value) { this.form.date.disabled=false; }">
            <option value="">Select Month</option>
            <option value="1">January</option>
            <option value="2">February</option>
            <option value="3">March</option>
            <option value="4">April</option>
            <option value="5">May</option>
            <option value="6">June</option>
            <option value="7">July</option>
            <option value="8">August</option>
            <option value="9">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
        </select>
    </div>
    
    <div class="form-group">
        <label for="year"><b>Year</b></label>
        <select id="year" name="year" class="form-control" 
                onfocus="this.form.date.disabled=true;" 
                onblur="if(!this.value && !this.form.month.value) { this.form.date.disabled=false; }">
            <option value="">Select Year</option>
            {% for yr in years %}
            <option value="{{ yr }}">{{ yr }}</option>
            {% endfor %}
        </select>
    </div>            
    
    <div class="form-group" id="part-group">
        <label for="part_number">Part Number</label>
        <select id="part_number" name="part_number">
            <option value="">Select Part Number</option>
            {% for part in part_numbers %}
                <option value="{{ part.id }}" {% if part.id|stringformat:"s" == selected_part_number %} selected {% endif %}>
                    {{ part.part_number }}
                </option>
            {% endfor %}
        </select>
    </div>
    <!-- Shift Selection --> 
    <div class="form-group" id="shift-group"> 
        <label for="shift">Shift</label> 
        <select id="shift" name="shift"> 
            <option value="">All </option> <!-- Default 'All' option --> 
            {% for shift in shifts %} 
                <option value="{{ shift.shift_name }}" {% if shift.shift_name == selected_shift %} selected {% endif %}> 
                    {{ shift.shift_name }} 
                </option> 
            {% endfor %} 
        </select> 
    </div>
    <div class="form-group">
        <label for="status">Status</label>
        <select id="status" name="status">
            <option value="OK" {% if request.GET.status == "OK" %}selected{% endif %}>OK </option>
            <option value="NOK" {% if request.GET.status == "NOK" %}selected{% endif %}>NOK</option>
        </select>
    </div>
    <div class="button-group">
        <button type="submit" id="generateReportButton" class="report-button"><i class="fas fa-file-alt"></i> Generate Report</button>
        <button type="button" onclick="exportToExcel()" class="excel-button"><i class="fas fa-file-excel"></i> Download Excel</button>
        <button type="button" onclick="exportToPDF()" class="pdf-button"><i class="fas fa-file-pdf"></i> Download PDF</button>
    </div>
</form>

<div class="report-container">
    <!-- Left-side Pie Chart with OK/NOK Counts -->
    <div class="left-section">
        {% if chart %}
            <img src="data:image/png;base64,{{ chart }}" alt="Status Pie Chart" class="large-pie-chart" />
        {% else %}
            <p>No data to display in pie chart.</p>
        {% endif %}

        <!-- OK and NOK Totals Below Pie Chart -->
        <div class="totals-info">
            <p>Total OK: {{ ok_count }}</p>
            <p>Total NOK: {{ nok_count }}</p>
        </div>

        <!-- Legend for OK and NOK -->
        <div class="legend">
            <div class="legend-item">
                <span class="legend-color ok-color"></span> OK
            </div>
            <div class="legend-item">
                <span class="legend-color nok-color"></span> NOK
            </div>
        </div>
    </div>
</div>

<!-- Display area for results -->
<div id="resultsContainer">
    <table class="data-table">    
        <thead>
            <tr>
                <th>Part Number</th>
                <th>Highest Value</th>
                <th>Station No</th>
                <th>Status</th>
                <th>Shift</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody>
            {% for report in report_data %}
                <tr>
                    <td>{{ report.part_number_id }}</td>
                    <td>{{ report.highest_value }}</td>
                    <td>{{ report.filter_no }}</td>
                    <td>{{ report.status }}</td>
                    <td>{{ report.shift }}</td>
                    <td>{{ report.date }}</td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="6">No data found for the selected status.</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- jQuery script -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
    $(document).ready(function () {
        $('#filterButton').on('click', function () {
            var formData = $('#filterForm').serialize();
            $.ajax({
                type: 'GET',
                url: 'report',
                data: formData,
                success: function (data) {
                    $('#resultsTableBody').empty(); // Clear previous results
                    if (data.length > 0) {
                        data.forEach(function (result) {
                            var newRow = "<tr>" +
                                "<td>" + result.model_name + "</td>" +
                                "<td>" + result.result + "</td>" +
                                "<td>" + result.shift + "</td>" +
                                "<td>" + result.date + "</td>" +
                                "</tr>";
                            $('#resultsTableBody').append(newRow);
                        });
                    } else {
                        $('#resultsTableBody').html('<tr><td colspan="5" class="no-results">No results found</td></tr>');
                    }
                    $('#resultsContainer').show(); // Show results container
                },
                error: function (error) {
                    console.log('Error fetching data:', error);
                }
            });
        });
    });

    function openContactModal() {
        document.getElementById('contactModal').style.display = 'block';
    }

    function closeContactModal() {
        document.getElementById('contactModal').style.display = 'none';
    }

    // Close modal if clicked outside of it
    window.onclick = function(event) {
        var modal = document.getElementById('contactModal');
        if (event.target == modal) {
            modal.style.display = 'none';
        }
        
        var imageModal = document.getElementById("imageModal");
        if (event.target == imageModal) {
            imageModal.style.display = "none";
        }
    };
    
    function showImage(url) {
        // Get the modal element and image element
        var modal = document.getElementById("imageModal");
        var modalImage = document.getElementById("modalImage");

        // Set the image URL and display the modal
        modalImage.src = url;
        modal.style.display = "block";
    }
    
    function closeModal() {
        // Hide the modal
        var modal = document.getElementById("imageModal");
        modal.style.display = "none";
    }
    
    function formatDate(input) {
        if (input.type === 'date' && input.value) {
            const [year, month, day] = input.value.split("-");
            if (year && month && day) {
                input.type = 'text'; // Change type back to text for display
                input.value = `${day}/${month}/${year}`;
            }
        }
    }
    
    function exportToExcel() {
        const reportTable = document.querySelector(".data-table");
        if (!reportTable) {
            alert("Table not found!");
            return;
        }

        const excelData = [];
        const rows = reportTable.querySelectorAll("thead tr, tbody tr");

        // Extract data from table rows
        rows.forEach((row, index) => {
            const rowData = [];
            row.querySelectorAll("th, td").forEach(cell => {
                rowData.push(cell.textContent.trim());
            });
            excelData.push(rowData);
        });

        // Create a worksheet and add data
        const worksheet = XLSX.utils.aoa_to_sheet(excelData);

        // Adjust column widths for better visibility
        worksheet["!cols"] = [
            { wch: 15 }, // Part Number
            { wch: 15 }, // Highest Value
            { wch: 15 }, // Station No
            { wch: 10 }, // Status
            { wch: 10 }, // Shift
            { wch: 15 }  // Date
        ];

        // Create a workbook and append the worksheet
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Report');

        // Save the workbook as an Excel file
        XLSX.writeFile(workbook, 'Generated_Report.xlsx');
    }

    function exportToPDF() {
        // Load jsPDF
        const { jsPDF } = window.jspdf;

        // Initialize a new PDF document
        const doc = new jsPDF('p', 'mm', 'a4'); // Portrait mode, millimeters, A4 size

        // Set the title for the PDF
        doc.setFontSize(14);
        doc.setTextColor(0, 51, 102); // Dark blue color
        doc.text("Generated Report", 14, 15);

        // Extract data from the table
        const reportTable = document.querySelector(".data-table");
        if (!reportTable) {
            alert("Table not found!");
            return;
        }

        const rows = Array.from(reportTable.querySelectorAll("tbody tr"));
        if (rows.length === 0) {
            alert("No data available to export.");
            return;
        }

        const pdfData = rows.map(row => 
            Array.from(row.querySelectorAll("td")).map(cell => cell.textContent.trim())
        );

        // Define the headers for the PDF table
        const headers = [
            ["Part Number", "Highest Value", "Station No", "Status", "Shift", "Date"]
        ];

        // Use autoTable to create the table in PDF
        doc.autoTable({
            head: headers,
            body: pdfData,
            startY: 25, // Start table below the title
            theme: 'striped', // Use striped theme for better readability
            styles: {
                fontSize: 7, // Smaller font size to fit more data
                cellPadding: 2, // Reduce padding for a tighter layout
                halign: 'center', // Center-align text
                overflow: 'linebreak', // Wrap text within the cell
            },
            headStyles: {
                fillColor: [0, 51, 102], // Dark blue header background
                textColor: [255, 255, 255], // White text in headers
                fontSize: 8, // Slightly larger font for headers
                fontStyle: 'bold', // Bold header text
                halign: 'center', // Center-align header text
            },
            alternateRowStyles: {
                fillColor: [240, 240, 240] // Light gray alternating rows
            },
            margin: { top: 25, left: 10, right: 10 }, // Proper margins to fit the table
            pageBreak: 'auto', // Automatically add page breaks when needed
            didDrawPage: function (data) {
                // Add a footer with the page number
                const pageCount = doc.internal.getNumberOfPages();
                doc.setFontSize(8);
                doc.setTextColor(100);
                doc.text(`Page ${pageCount}`, data.settings.margin.left, doc.internal.pageSize.height - 10);
            }
        });
        // Save the PDF file
        doc.save('Generated_Report.pdf');
    }
    
    function renderPieChart(okCount, notOkCount) {
        const ctx = document.getElementById('jobStatusChart').getContext('2d');
        // Destroy any existing chart instance
        if (window.jobStatusChart) {
            window.jobStatusChart.destroy();
        }

        window.jobStatusChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['OK', 'Not OK'],
                datasets: [{
                    label: 'Job Status',
                    data: [okCount, notOkCount],
                    backgroundColor: ['#4CAF50', '#FF5722'],
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Job Status Summary'
                    }
                }
            }
        });
    }
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const dateInput = document.getElementById("date");
        const monthSelect = document.getElementById("month");
        const yearSelect = document.getElementById("year");

        // Debugging: Check if elements are found
        console.log("Date Input:", dateInput);
        console.log("Month Select:", monthSelect);
        console.log("Year Select:", yearSelect);

        function toggleFields() {
            console.log("Date Value:", dateInput.value);
            console.log("Month Value:", monthSelect.value);
            console.log("Year Value:", yearSelect.value);

            if (dateInput.value) {
                console.log("Disabling Month & Year...");
                monthSelect.disabled = true;
                yearSelect.disabled = true;
                monthSelect.value = ""; // Clear month selection
                yearSelect.value = ""; // Clear year selection
            } else if (monthSelect.value && yearSelect.value) {
                console.log("Disabling Date...");
                dateInput.disabled = true;
                dateInput.value = ""; // Clear date selection
            } else {
                console.log("Enabling all fields...");
                dateInput.disabled = false;
                monthSelect.disabled = false;
                yearSelect.disabled = false;
            }
        }

        // Event Listeners with Logging
        dateInput.addEventListener("change", function () {
            console.log("Date Changed:", dateInput.value);
            toggleFields();
        });

        monthSelect.addEventListener("change", function () {
            console.log("Month Changed:", monthSelect.value);
            toggleFields();
        });

        yearSelect.addEventListener("change", function () {
            console.log("Year Changed:", yearSelect.value);
            toggleFields();
        });

        // Ensure fields are set correctly on load
        toggleFields();
    });
</script>
{% endblock %}